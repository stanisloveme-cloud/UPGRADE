
name: Setup Infrastructure

on:
  workflow_dispatch:

jobs:
  configure-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Swap Space
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Copy script content directly (using heredoc to avoid file transfer issues)
            cat > /tmp/setup_swap.sh << 'EOF'
            #!/bin/bash
            set -e
            SWAP_SIZE_GB=2
            SWAP_FILE="/swapfile"
            
            echo "Current Memory:"
            free -h

            if [ -f "$SWAP_FILE" ]; then
                echo "Swap file $SWAP_FILE exists."
            else
                echo "Creating $SWAP_SIZE_GB GB swap file..."
                # Use dd if fallocate fails (more compatible)
                dd if=/dev/zero of=$SWAP_FILE bs=1G count=$SWAP_SIZE_GB
                chmod 600 $SWAP_FILE
                mkswap $SWAP_FILE
                swapon $SWAP_FILE
                echo "$SWAP_FILE none swap sw 0 0" | tee -a /etc/fstab
                echo "Swap created!"
            fi

            # Optimize swappiness
            sysctl vm.swappiness=10
            
            echo "New Memory Stats:"
            free -h
            EOF

            chmod +x /tmp/setup_swap.sh
            sudo /tmp/setup_swap.sh
