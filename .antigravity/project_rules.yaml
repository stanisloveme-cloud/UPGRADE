# GOOGLE ANTI-GRAVITY CONFIGURATION
# Project: Upgrade (Business Program Editor)
# Version: 1.1.0

metadata:
  project_name: "Upgrade CRM Core"
  description: "Business Program Editor for Conferences"
  docs_root: "./docs"

# -----------------------------------------------------------------------------
# 1. TECHNOLOGY STACK (HARD CONSTRAINTS)
# -----------------------------------------------------------------------------
stack:
  backend:
    framework: "NestJS"
    language: "TypeScript (Strict)"
    orm: "Prisma"
    database: "PostgreSQL 15+"
    api_style: "REST + Swagger"
  
  frontend:
    framework: "React 18+"
    build_tool: "Vite"
    ui_library: "Ant Design v5"
    pro_components: "@ant-design/pro-components"
    state: "Zustand"
  
  infrastructure:
    containerization: "Docker + Docker Compose"
    ci_cd: "GitHub Actions"
    reverse_proxy: "Nginx"
    policy: "Infrastructure as Code (IaC)"

# -----------------------------------------------------------------------------
# 2. RULES (THE "DO NOT" LIST)
# -----------------------------------------------------------------------------
rules:
  # --- UI & Design System ---
  - id: "ui-strict-antd"
    severity: "critical"
    description: "Do NOT use custom CSS for layout. Use <ProLayout>, <ProCard>, <Space> and Ant Design Tokens only."
  
  - id: "deploy-verify-always"
    description: "Always verify the deployment by checking 3 things: 1) Container status (HEALTHY), 2) Application logs (for crashes), 3) HTTP access (curl/browser). Do not assume success based on CI status alone."
    severity: "error"

  - id: "cli-non-interactive"
    description: "Never use interactive CLI commands (like 'gh run watch' without ID or interactive prompts). Always use direct IDs and non-interactive flags to prevent agent hanging."
    severity: "error"

  - id: "cli-non-interactive"
    description: "Never use interactive CLI commands (like 'gh run watch' without ID or interactive prompts). Always use direct IDs and non-interactive flags to prevent agent hanging."
    severity: "error"

  - id: "ui-form-patterns"
    severity: "error"
    description: "For entity editing (Session, Speaker), ALWAYS use <DrawerForm> or <ModalForm>. Do not build raw HTML forms."

  # --- Backend Architecture ---
  - id: "be-modular-structure"
    severity: "error"
    description: "Enforce NestJS Modular Architecture: Module -> Controller -> Service -> Repository. No logic in Controllers."

  # --- Infrastructure & Release ---
  - id: "infra-immutable"
    severity: "critical"
    description: "Never suggest editing files directly on the server via SSH. All config changes must go through Git."
  
  - id: "infra-secrets-safety"
    severity: "critical"
    description: "Never commit .env files. Use .env.example for templates. Secrets are managed via CI/CD variables."

  # --- Shell & Execution Stability (CRITICAL) ---
  - id: "shell-no-blocking"
    severity: "critical"
    description: >
      ABSOLUTE BAN on running blocking commands.
      NEVER run: 'npm run start', 'nest start --watch', 'docker-compose up' (without -d).
      ACTION: Ask the User to run servers in a separate terminal.

  - id: "shell-path-awareness"
    severity: "critical"
    description: >
      PROJECT STRUCTURE TRUTH (DO NOT HALLUCINATE):
      - Frontend is in `./client` (NOT /frontend).
      - Backend is in `./src` (NOT /backend).
      - Infrastructure files are in `./` (Root), NOT /infra.
      ALWAYS adjust paths in commands and imports accordingly.

  - id: "infra-code-only"
    severity: "critical"
    description: >
      Infrastructure (Docker, Nginx, GitHub Actions) must be code.
      If `.github/workflows/deploy.yml` is missing, IT MUST BE CREATED based on the actual folder structure.

  - id: "shell-safe-execution"
    severity: "critical"
    description: >
      POWERSHELL & TOOLING RULES:
      1. NO PARALLEL DEPENDENT COMMANDS: Never run `git add`, `git commit` in parallel tool calls. Git locks will fail. Use `waitForPreviousTools: true`.
      2. USE POWERSHELL SYNTAX: No `grep`, `touch`, `rm -rf`, `export`. Use `Select-String`, `New-Item`, `Remove-Item`, `$env:VAR=VAL`.
      3. NON-INTERACTIVE: Always assume no user input is possible.

# -----------------------------------------------------------------------------
# 3. WORKFLOWS (STANDARD OPERATING PROCEDURES)
# -----------------------------------------------------------------------------
workflows:
  - name: "scaffold-new-feature"
    description: "End-to-end creation of a new business entity"
    steps:
      - "Analyze `docs/analysis/00_Legacy_System_Analysis.md` for business logic."
      - "Check `docs/prd/` for specific field requirements."
      - "Create DB Migration (Prisma)."
      - "Generate NestJS Module (Controller/Service/DTO)."
      - "Generate React Types & API Client."
      - "Scaffold UI using ProTable/ProForm."

  - name: "deploy-infrastructure"
    description: "Setup server environment from scratch"
    steps:
      - "Read `docs/prd/06_Infrastructure_and_Release.md`."
      - "Generate Dockerfiles for Front/Back."
      - "Create `docker-compose.yml` with Postgres/Redis."
      - "Generate Nginx Config."
      - "Create GitHub Actions workflow."