# GOOGLE ANTI-GRAVITY CONFIGURATION
# Project: Upgrade (Business Program Editor)

# -----------------------------------------------------------------------------
# 1. TECHNOLOGY STACK (HARD CONSTRAINTS)
# -----------------------------------------------------------------------------
stack:
  backend:
    framework: "NestJS"
    language: "TypeScript (Strict)"
    orm: "Prisma"
    database: "PostgreSQL 15+"
    api_style: "REST + Swagger"
  
  frontend:
    framework: "React 18+"
    build_tool: "Vite"
    ui_library: "Ant Design v5"
    pro_components: "@ant-design/pro-components"
    state: "Zustand"
  
  infrastructure:
    containerization: "Docker + Docker Compose"
    ci_cd: "GitHub Actions"
    reverse_proxy: "Nginx"
    policy: "Infrastructure as Code (IaC)"

# -----------------------------------------------------------------------------
# 2. RULES (THE "DO NOT" LIST)
# -----------------------------------------------------------------------------
rules:
  # --- UI & Design System ---
  - id: "ui-strict-antd"
    severity: "critical"
    description: "Do NOT use custom CSS for layout. Use <ProLayout>, <ProCard>, <Space> and Ant Design Tokens only."

  - id: "ui-form-patterns"
    severity: "error"
    description: "For entity editing (Session, Speaker), ALWAYS use <DrawerForm> or <ModalForm>. Do not build raw HTML forms."

  # --- Backend Architecture ---
  - id: "be-modular-structure"
    severity: "error"
    description: "Enforce NestJS Modular Architecture: Module -> Controller -> Service -> Repository. No logic in Controllers."

  # --- Infrastructure & Release ---
  - id: "infra-immutable"
    severity: "critical"
    description: "Never suggest editing files directly on the server via SSH. All config changes must go through Git."

  - id: "infra-secrets-safety"
    severity: "critical"
    description: "Never commit .env files. Use .env.example for templates. Secrets are managed via CI/CD variables."

  - id: "deploy-verify-always"
    severity: "error"
    description: "Always verify the deployment by checking 3 things: 1) Container status (HEALTHY), 2) Application logs (for crashes), 3) HTTP access (curl/browser). Do not assume success based on CI status alone."

  # --- Shell & Execution Stability (CRITICAL) ---
  - id: "shell-no-blocking"
    severity: "critical"
    description: >
      ABSOLUTE BAN on running blocking commands.
      NEVER run: 'npm run start', 'nest start --watch', 'docker-compose up' (without -d).
      ACTION: Ask the User to run servers in a separate terminal.

  - id: "shell-path-awareness"
    severity: "critical"
    description: >
      PROJECT STRUCTURE TRUTH (DO NOT HALLUCINATE):
      - Frontend is in `./client` (NOT /frontend).
      - Backend is in `./src` (NOT /backend).
      - Infrastructure files are in `./` (Root), NOT /infra.
      ALWAYS adjust paths in commands and imports accordingly.

  - id: "infra-code-only"
    severity: "critical"
    description: >
      Infrastructure (Docker, Nginx, GitHub Actions) must be code.
      If `.github/workflows/deploy.yml` is missing, IT MUST BE CREATED based on the actual folder structure.

  - id: "cli-non-interactive"
    severity: "error"
    description: "Never use interactive CLI commands (like 'gh run watch' without ID or interactive prompts). Always use direct IDs and non-interactive flags to prevent agent hanging."

# -----------------------------------------------------------------------------
# 3. WORKFLOWS (STANDARD OPERATING PROCEDURES)
# -----------------------------------------------------------------------------
workflows:
  - name: "scaffold-new-feature"
    description: "End-to-end creation of a new business entity"
    steps:
      - "Analyze `docs/analysis/00_Legacy_System_Analysis.md` for business logic."
      - "Check `docs/prd/` for specific field requirements."
      - "Create DB Migration (Prisma)."
      - "Generate NestJS Module (Controller/Service/DTO)."
      - "Generate React Types & API Client."
      - "Scaffold UI using ProTable/ProForm."

  - name: "deploy-infrastructure"
    description: "Setup server environment from scratch"
    steps:
      - "Read `docs/prd/06_Infrastructure_and_Release.md`."
      - "Generate Dockerfiles for Front/Back."
      - "Create `docker-compose.yml` with Postgres/Redis."
      - "Generate Nginx Config."
      - "Create GitHub Actions workflow."

# -----------------------------------------------------------------------------
# 4. MCP INTEGRATIONS (Agent tooling)
# -----------------------------------------------------------------------------
mcp_rules:
  - id: "mcp-context7-mandatory"
    severity: "critical"
    description: >
      BEFORE writing any code or architecture involving a library/framework,
      ALWAYS query MCP context7 (mcp_context7_resolve-library-id + mcp_context7_query-docs)
      to verify the API is current (2025-2026). Never rely on training-data assumptions.
      Applies to: NestJS, Prisma, React, Ant Design, Vite, Docker, etc.

  - id: "mcp-github-native"
    severity: "critical"
    description: >
      ABSOLUTE BAN on running terminal `git` commands (e.g., git add, git commit, git push).
      ALL repository operations (commits, pushes, branching, creating PRs, reading files)
      MUST be performed exclusively via the configured native GitHub MCP server tools (mcp_github_*).
      AVOID using 'gh' CLI or 'node scripts/check_deploy.js' unless MCP is temporarily unavailable.
      The GitHub MCP token is configured in C:\Users\PC\.gemini\antigravity\mcp_config.json.
